<script>
(function(){
  try{
    const cfg = {
      items: {{ promo.items | jsonify }},
      rotation: {{ promo.rotation | jsonify }},
      rememberHours: 0,  // << Forçado a 0: não lembra fechamento
      oncePerSession: false, // << Mostra sempre que mudar de página
      hideOn: {{ promo.hide_on_paths | default: "[]" | jsonify }}
    };

    const path = location.pathname.replace(/\/+$/,'') || '/';
    if (Array.isArray(cfg.hideOn) && cfg.hideOn.includes(path)) return;

    const pool = (cfg.items||[]).filter(it => it && it.active);
    if (!pool.length) return;

    function pickRandom(list){
      return list[Math.floor(Math.random()*list.length)];
    }
    function pickWeighted(list){
      const arr = [];
      list.forEach(it=>{
        const w = Math.max(1, Number(it.weight||1));
        for(let i=0;i<w;i++) arr.push(it);
      });
      return pickRandom(arr);
    }
    const chosen = (cfg.rotation === "weighted-random") ? pickWeighted(pool) : pickRandom(pool);
    if (!chosen) return;

    const box   = document.getElementById("md-promo");
    const link  = box.querySelector(".md-promo__body");
    const img   = box.querySelector(".md-promo__img img");
    const ttl   = box.querySelector(".md-promo__title");
    const desc  = box.querySelector(".md-promo__desc");
    const cta   = box.querySelector(".md-promo__cta");

    link.href = chosen.url || "#";
    img.src = chosen.image || "";
    img.alt = chosen.title || "Oferta";
    ttl.textContent  = chosen.title || "Produto";
    desc.textContent = chosen.text  || "";
    cta.textContent  = chosen.cta   || "Ver";

    box.hidden = false;

    // Fecha manualmente sem bloquear reexibição
    box.querySelector(".md-promo__close").addEventListener("click", function(ev){
      ev.stopPropagation();
      box.hidden = true;
    });
  }catch(e){}
})();
</script>