{% assign promo = site.data.promo %}
{% if promo and promo.enabled %}
<div id="md-promo" class="md-promo" role="dialog" aria-live="polite" aria-label="Oferta" hidden>
  <button class="md-promo__close" aria-label="Fechar oferta" title="Fechar">×</button>

  {# 1) href inicial válido para o proofer; JS sobrescreve depois #}
  <a class="md-promo__body"
     href="{{ '/' | relative_url }}"
     data-href="" 
     target="_blank" rel="noopener nofollow external">
    <div class="md-promo__img">
      {# 2) src inicial válido p/ proofer (pixel transparente) #}
      <img alt="Produto recomendado"
           loading="lazy" decoding="async"
           src="data:image/gif;base64,R0lGODlhAQABAAAAACw=">
    </div>
    <div class="md-promo__text">
      <strong class="md-promo__title"></strong>
      <span class="md-promo__desc"></span>
      <span class="md-promo__note">eu selecionei esse item; link oficial/afiliado ✅</span>
      <span class="md-promo__cta">Ver</span>
    </div>
  </a>
</div>

<style>
/* … (seu CSS permanece igual) … */
</style>

<script>
(function(){
  try{
    const cfg = {
      items: {{ promo.items | jsonify }},
      rotation: {{ promo.rotation | jsonify }},
      rememberHours: 0,
      oncePerSession: false,
      hideOn: {{ promo.hide_on_paths | default: "[]" | jsonify }}
    };

    const path = location.pathname.replace(/\/+$/,'') || '/';
    if (Array.isArray(cfg.hideOn) && cfg.hideOn.includes(path)) return;

    const pool = (cfg.items||[]).filter(it => it && it.active);
    if (!pool.length) return;

    const pickRandom = list => list[Math.floor(Math.random()*list.length)];
    const pickWeighted = list => {
      const arr=[]; list.forEach(it=>{ const w=Math.max(1,Number(it.weight||1)); for(let i=0;i<w;i++) arr.push(it); });
      return pickRandom(arr);
    };
    const chosen = (cfg.rotation === "weighted-random") ? pickWeighted(pool) : pickRandom(pool);
    if (!chosen) return;

    const box   = document.getElementById("md-promo");
    const link  = box.querySelector(".md-promo__body");
    const img   = box.querySelector(".md-promo__img img");
    const imgWrap = box.querySelector(".md-promo__img");
    const ttl   = box.querySelector(".md-promo__title");
    const desc  = box.querySelector(".md-promo__desc");
    const cta   = box.querySelector(".md-promo__cta");

    // Atualiza conteúdo
    const href = chosen.url || "{{ '/' | relative_url }}";
    link.setAttribute("href", href);
    link.setAttribute("data-href", href);
    if (/^https?:\/\//i.test(href)) {
      link.setAttribute("target","_blank");
      link.setAttribute("rel","noopener nofollow external");
    } else {
      link.removeAttribute("target");
      link.setAttribute("rel","nofollow");
    }

    ttl.textContent  = chosen.title || "Produto";
    desc.textContent = chosen.text  || "";
    cta.textContent  = chosen.cta   || "Ver";

    if (chosen.image){
      img.src = chosen.image;
      img.alt = chosen.title || "Produto recomendado";
      imgWrap.style.display = "";
    } else {
      imgWrap.style.display = "none";
      box.querySelector(".md-promo__body").style.gridTemplateColumns = "1fr";
    }

    // Mostra
    box.hidden = false;
    requestAnimationFrame(()=> box.classList.add("show"));

    // Fechar (sem lembrar)
    box.querySelector(".md-promo__close").addEventListener("click", function(ev){
      ev.stopPropagation();
      box.classList.remove("show");
      setTimeout(()=>{ box.hidden = true; }, 200);
    });
  }catch(e){}
})();
</script>
{% endif %}