{% assign promo = site.data.promo %}
{% if promo and promo.enabled %}
<div id="md-promo" class="md-promo" role="dialog" aria-live="polite" aria-label="Oferta" hidden>
  <button class="md-promo__close" aria-label="Fechar oferta" title="Fechar">×</button>

  <a class="md-promo__body"
     href="{{ '/' | relative_url }}" data-href=""
     target="_blank" rel="noopener nofollow external"
     data-proofer-ignore>
    <div class="md-promo__img">
      <img alt="Produto recomendado"
           loading="lazy" decoding="async"
           src="data:image/gif;base64,R0lGODlhAQABAAAAACw="
           data-proofer-ignore>
    </div>
    <div class="md-promo__text">
      <strong class="md-promo__title"></strong>
      <span class="md-promo__desc"></span>
      <span> Eu achei esse produto com ótimo custo-benefício.
</span>
      <span class="md-promo__cta">Ver</span>
    </div>
  </a>
</div>

<style>
.md-promo{ position:fixed; right:16px; bottom:16px; z-index:9999; max-width:320px; width:calc(100vw - 24px);
  background:#0f0f0f; border:1px solid #1f1f1f; color:#eee; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.45);
  overflow:hidden; font-family:inherit; opacity:0; transform:translateY(8px); transition:opacity .25s, transform .25s; }
.md-promo.show{ opacity:1; transform:translateY(0); }
.md-promo[hidden]{ display:none!important; }
.md-promo__body{ display:grid; grid-template-columns:96px 1fr; gap:10px; text-decoration:none; color:inherit; padding:10px 12px 12px 10px; }
.md-promo__img{ width:96px; height:96px; border-radius:12px; overflow:hidden; background:#000; }
.md-promo__img img{ width:100%; height:100%; object-fit:cover; display:block; }
.md-promo__text{ display:flex; flex-direction:column; gap:4px; }
.md-promo__title{ font-size:1rem; color:#fff; }
.md-promo__desc{ font-size:.9rem; color:#cfcfcf; }
.md-promo__note{ font-size:.8rem; opacity:.8; color:#9ad29a; }
.md-promo__cta{ margin-top:6px; align-self:flex-start; background:#d62828; color:#fff; font-weight:700; padding:.45rem .7rem; border-radius:10px; }
.md-promo__body:hover .md-promo__cta{ background:#ff4040; }
.md-promo__close{ position:absolute; top:6px; right:8px; width:28px; height:28px; border:0; border-radius:999px; background:#1a1a1a;
  color:#ddd; cursor:pointer; font-size:18px; line-height:1; display:flex; align-items:center; justify-content:center; }
.md-promo__close:hover{ background:#272727; color:#fff; }
@media (max-width:480px){ .md-promo{ right:10px; left:10px; bottom:10px; max-width:none; } }
</style>

<script>
(function(){
  try{
    const cfg = {
      items: {{ promo.items | jsonify }},
      rotation: {{ promo.rotation | jsonify }},
      rememberHours: 0,
      oncePerSession: false,
      hideOn: {{ promo.hide_on_paths | default: "[]" | jsonify }}
    };

    // base respeitando baseurl do Jekyll
    const BASE = "{{ '' | relative_url }}";
    const resolveUrl = (u)=>{
      if (!u) return "";
      return /^https?:\/\//i.test(u) ? u : (BASE.replace(/\/$/,'') + '/' + u.replace(/^\//,''));
    };

    const path = location.pathname.replace(/\/+$/,'') || '/';
    if (Array.isArray(cfg.hideOn) && cfg.hideOn.includes(path)) return;

    const pool = (cfg.items||[]).filter(it => it && it.active);
    if (!pool.length) return;

    const pickRandom = list => list[Math.floor(Math.random()*list.length)];
    const pickWeighted = list => { const arr=[]; list.forEach(it=>{ const w=Math.max(1,Number(it.weight||1)); for(let i=0;i<w;i++) arr.push(it); }); return pickRandom(arr); };
    const chosen = (cfg.rotation === "weighted-random") ? pickWeighted(pool) : pickRandom(pool);
    if (!chosen) return;

    const box   = document.getElementById("md-promo");
    const link  = box.querySelector(".md-promo__body");
    const img   = box.querySelector(".md-promo__img img");
    const imgWrap = box.querySelector(".md-promo__img");
    const ttl   = box.querySelector(".md-promo__title");
    const desc  = box.querySelector(".md-promo__desc");
    const cta   = box.querySelector(".md-promo__cta");

    const href = resolveUrl(chosen.url || "{{ '/' | relative_url }}");
    link.setAttribute("href", href);
    link.setAttribute("data-href", href);
    if (/^https?:\/\//i.test(href)) { link.setAttribute("target","_blank"); link.setAttribute("rel","noopener nofollow external"); }
    else { link.removeAttribute("target"); link.setAttribute("rel","nofollow"); }

    ttl.textContent  = chosen.title || "Produto";
    desc.textContent = chosen.text  || "";
    cta.textContent  = chosen.cta   || "Ver";

    if (chosen.image){
      img.src = resolveUrl(chosen.image);
      img.alt = chosen.title || "Produto recomendado";
      imgWrap.style.display = "";
    } else {
      imgWrap.style.display = "none";
      box.querySelector(".md-promo__body").style.gridTemplateColumns = "1fr";
    }

    box.hidden = false;
    requestAnimationFrame(()=> box.classList.add("show"));

    box.querySelector(".md-promo__close").addEventListener("click", function(ev){
      ev.stopPropagation();
      box.classList.remove("show");
      setTimeout(()=>{ box.hidden = true; }, 200);
    });
  }catch(e){}
})();
</script>
{% endif %}